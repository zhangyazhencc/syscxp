# 一. syscxp-tunnel
> ## 1. 项目部署

> ## 2. 数据初始化
+ Tunnel数据初始化
    - 丁春雨处理
+ 监控主机导入（开启后是否会影响原监控agent）？
    - 丁春雨处理
+ 监控ip导入，开启监控用原来的监控ip
    - 导入falcon_portal.tunnel_icmp 至 syscxp_tunnel
    - 调用存储过程，按 tunnel_icmp更新tunnel的 monitorCidr，monitorState
    - 检查TunnelVO数据
        - （是否存在 (monitorState=true and monitorCidr=null) or (monitorState=false and monitorCidr!=null)）
    - 调用初始化监控数据消息（APIInitTunnelMonitorMsg）
        - 循环 TunnelVO，初始化监控数据
        - 执行存储过程修改监控ip,monitorCidr
        - 循环 TunnelVO ，下发控制器（仅保存zookeeper），成功后修改TunnelVO.monitorState
        - agent不下发，让监控机自动获取
        - 数据检查
            - 检查 TunnelVO， TunnelMonitorVO数据
            - 检查agent数据
            - 检查zk数据
        - 检查数据有问题，需要再次调用消息（考虑原下发数据的清除或更新）
          
> ## 3. 测试验证
+ 监控主机添加（查看agent状态）
+ 监控开启、监控关闭
+ 修改监控ip
+ 修改通道vlan、带宽、端口
+ 专线中止、专线删除
+ 监控机删除
+ 修改监控接口
+ 共点

> ## 4. 监控数据查看（开通监控后）
    - OpenTSDB数据查看
    - 通道数据查看 
    - 测速
    - 网络工具

# 二. falcon-api
> ## 1. 备份原falcon_portal数据（新数据会替换旧数据）
> ## 2. 表结构调整
     ALTER TABLE tunnel_icmp MODIFY tunnel_id VARCHAR(32);
     ALTER TABLE tunnel_icmp MODIFY endpointA_id VARCHAR(32);
     ALTER TABLE tunnel_icmp MODIFY endpointB_id VARCHAR(32);
     ALTER TABLE tunnel_alarm_history MODIFY tunnel_id VARCHAR(32);                                        
     ALTER TABLE tunnel_strategy MODIFY tunnel_id VARCHAR(32);
     ALTER TABLE tunnel_strategy ADD regulation_id VARCHAR(32) COMMENT '规则UUID(syscxp_alarm.RegulationVO.uuid)' AFTER stay_time;
     ALTER TABLE tunnel_strategy ADD bandwidth BIGINT(20) COMMENT '带宽' AFTER regulation_id;
     ALTER TABLE expression ADD regulation_id VARCHAR(32) NOT NULL COMMENT '规则UUID(syscxp_alarm.RegulationVO.uuid)' AFTER action_id;
     ALTER TABLE expression ADD resource_uuid VARCHAR(32) COMMENT '资源uuid' AFTER regulation_id;

> ## 2. 代码更新
    
> ## 3. 服务验证

+ 查看日志

> ## 4. 数据初始化
+ 原数据备份后，清空数据库 
+ syscxp-alarm 初始化后同步到falcon-portal
+ 初始化后数据验证

# 三. open-falcon

> ## 1. hbs
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 2. judge
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 3. alarm
+ 停止服务
    - ./control stop
    - ./control status

# 四. syscxp-alarm
> ## 1. 项目部署

> ## 2. 数据初始化
+ 告警策略、告警规则、策略规则绑定、策略资源绑定
    - 数据整理
	    - falcon_portal.tunnel_strategy 数据导入 syscxp_alarm
	    - 新增 comparison_rule_uuid, monitor_target_uuid, policy_uuid, reguration_uuid 字段
	- 新建临时表
            
            CREATE TABLE reguration_ts_temp (
            	tunnel_id VARCHAR (32),
            	policy_id VARCHAR (32),
            	reguration_id VARCHAR (32),
            	ts_id VARCHAR (32)
            );
    
    - 存储过程同步数据 PolicyVO, RegurationVO, ResourcePolicyRefVO
            
            CALL proc_tunnel_strategy_init;
      
    - 调用接口（APIInitAlarmStrategyMsg），同步策略规则至falcon

            {
              "com.syscxp.alarm.header.resourcePolicy.APIInitAlarmStrategyMsg": {
                "session": {
                  "uuid": "5d23815f547d42b4959b2896a8e03da8"
                }
              }
            }
    - 数据验证
        - 检查 PolicyVO, RegurationVO, ResourcePolicyRefVO（syscxp_alarm）
        - 检查 tunnel_strategy， expression（falcon_portal）
        - 检查数据有问题，需要再次调用消息（考虑原下发数据的清除或更新
        
    - 问题
        目前存在触发周期为10次的数据，alarm默认最大5次，是否需要调整？
        在接口执行存储过程测试？
    
+ 告警联系人
    - 数据整理
        - uic.user表数据导入 syscxp_alarm
    - 调用存储过程初始化数据
    
            CALL proc_contact_init
    - 数据验证
        - 检查 ContactVO，ContactNotifyWayRefVO（syscxp_alarm）
        - 检查数据有问题，修改后重新执行存储过程
        
                SELECT a.`cnname` old_name ,b.`name` as new_name,
                       a.`name` as old_acc,b.accountUuid as new_acc,
                       a.email as old_mail,b.email as new_mail,
                       a.phone as old_phone,b.mobile as new_phone,
                       b.uuid as contactUuid,d.`code`
                 FROM user a 
                    LEFT JOIN ContactVO b ON b.accountUuid = a.`name` AND b.`name` = a.cnname AND b.email = a.email and b.mobile = a.phone
                    LEFT JOIN ContactNotifyWayRefVO c ON c.contactUuid = b.uuid
                    LEFT JOIN NotifyWayVO d ON d.uuid = c.notifyWayUuid;
                
+ 功能测试
    
# 五. 监控agent
+ tunnel部署后，新建监控主机
+ 自动部署并启动agent
+ 查看agent状态、配置文件、log，确保agent运行正常