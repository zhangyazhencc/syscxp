# 一. syscxp-tunnel
> ## 1. 项目部署

> ## 2. 数据初始化
+ tunnel数据初始化
+ 调用接口初始化监控数据（新增，或与通道初始化同时进行）
    - 新增临时表处理数据（看实际是否需要）
    - 修改TunnelVO：monitorState、monitorCidr
    - 新增TunnelMonitorVO数据
    - 下发zk数据
+ 初始化数据验证
+ 监控ip导入，开启监控用原来的监控ip？
+ 监控主机导入（开启后是否会影响原监控agent）？

> ## 3. 测试验证
+ 监控主机添加（查看agent状态）
+ 监控开启、监控关闭
+ 修改监控ip
+ 修改通道vlan、带宽、端口
+ 专线中止、专线删除
+ 监控机删除
+ 修改监控接口
+ 共点

> ## 4. 监控数据查看（开通监控后）
    - OpenTSDB数据查看
    - 通道数据查看 
    - 测速
    - 网络工具

# 二. falcon-api
> ## 1. 表结构调整
+ tunnel_strategy


    DROP TABLE IF EXISTS `tunnel_strategy`;
    CREATE TABLE `tunnel_strategy` (
      `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
      `tunnel_id` varchar(32) DEFAULT NULL,
      `user_id` varchar(64) DEFAULT NULL,
      `strategy_type` varchar(255) DEFAULT NULL,
      `op` varchar(8) DEFAULT NULL,
      `right_value` varchar(64) DEFAULT NULL,
      `stay_time` int(11) DEFAULT NULL,
      `regulation_id` varchar(32) DEFAULT NULL COMMENT 'ALARM中的规则ID',
      `bandwidth` bigint(20) DEFAULT NULL COMMENT '带宽',
      `created` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=847 DEFAULT CHARSET=utf8;

+ expression


    DROP TABLE IF EXISTS `expression`;
    CREATE TABLE `expression` (
      `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
      `expression` varchar(1024) NOT NULL,
      `func` varchar(16) NOT NULL DEFAULT 'all(#1)',
      `op` varchar(8) NOT NULL DEFAULT '',
      `right_value` varchar(16) NOT NULL DEFAULT '',
      `max_step` int(11) NOT NULL DEFAULT '1',
      `priority` tinyint(4) NOT NULL DEFAULT '0',
      `note` varchar(1024) NOT NULL DEFAULT '',
      `action_id` int(10) unsigned NOT NULL DEFAULT '0',
      `regulation_id` varchar(32) NOT NULL COMMENT '规则UUID(syscxp_alarm.RegulationVO.uuid)',
      `resource_uuid` varchar(32) DEFAULT NULL COMMENT '资源uuid',
      `create_user` varchar(64) NOT NULL DEFAULT '',
      `pause` tinyint(1) NOT NULL DEFAULT '0',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=1478 DEFAULT CHARSET=utf8;

> ## 2. 代码更新
    
> ## 3. 服务验证
+ 查看日志

> ## 4. 数据初始化
+ 原数据备份后，清空数据库 
+ syscxp-alarm 初始化后同步到falcon-portal
+ 初始化后数据验证

# 三. open-falcon

> ## 1. hbs
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 2. judge
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 3. alarm
+ 停止服务
    - ./control stop
    - ./control status

# 四. syscxp-alarm
> ## 1. 项目部署

> ## 2. 数据初始化
+ 告警策略、告警规则、策略规则绑定、策略资源绑定
    - 数据整理
	    - tunnel_strategy 数据导入 syscxp_alarm
	    - 新增 comparison_rule_uuid, monitor_target_uuid, policy_uuid, reguration_uuid 字段
	    - 数据更新
	    
                UPDATE tunnel_strategy a 
                   SET comparison_rule_uuid = (select uuid from ComparisonRuleVO where comparisonValue = a.op), 
                       monitor_target_uuid = (select uuid from MonitorTargetVO where targetValue = a.strategy_type)
                       stay_time = stay_time*2;
        - 更新数据验证
            
                SELECT * FROM tunnel_strategy a WHERE a.comparison_rule_uuid is null or a.monitor_target_uuid is null;
            
	- 新建 reguration_ts_temp( tunnel_id, policy_id, reguration_id, ts_id ) 表（ tunnel_strategy 与 RegurationVO 的关联表 ）
            
            CREATE TABLE reguration_ts_temp (
            	tunnel_id VARCHAR (32),
            	policy_id VARCHAR (32),
            	reguration_id VARCHAR (32),
            	ts_id VARCHAR (32)
            );
    
    - 存储过程同步数据到 PolicyVO, RegurationVO, ResourcePolicyRefVO
    
    - 新建alarm接口，查询 ResourcePolicyRefVO 纪录后，执行更新falcon操作 

+ 告警联系人
    
+ 功能测试

# 五. 监控agent
+ tunnel部署后，新建监控主机
+ 自动部署并启动agent
+ 查看agent状态、配置文件、log，确保agent运行正常