# 一. syscxp-tunnel
> ## 1. 项目部署

> ## 2. 数据初始化
+ 修改配置信息
    - OpenTSDB地址
    - MongoDB地址
+ Tunnel数据初始化
    - 丁春雨处理
+ 监控主机导入
    - 丁春雨处理
    - 自动部署并启动agent
    - 关闭监控主机原监控agent（不关闭会导致数据重复采集）
    - 查看agent状态、配置文件、log，确保agent运行正常

+ 开启监控（使用原监控ip）
    - 导入falcon_portal.tunnel_icmp 至 syscxp_tunnel
    - 增加check_result，endpointA_switch_port_id,endpointB_switch_port_id 栏位
    - 调用存储过程，按 tunnel_icmp更新tunnel的 monitorCidr
    
            call proc_monitor_init_update_tunnel
    
    - 检查数据
        - falcon_portal.tunnel_icmp.check_result 为空
        - monitorCidr、endpointA_switch_port_id、endpointB_switch_port_id不为空
            
            SELECT a.tunnel_id,a.cidr,b.monitorCidr,b.monitorState,
                   a.check_result,endpointA_switch_port_id,endpointB_switch_port_id
              FROM tunnel_icmp a 
              LEFT JOIN tunnelvo b ON b.uuid = a.tunnel_id;
    - 调用初始化监控数据消息（APIInitTunnelMonitorMsg）
        - 备份ZK书数据
    
            {
                "com.syscxp.header.tunnel.monitor.APIInitTunnelMonitorMsg": {
                    "session": {
                        "uuid": "fc0df4c81aa847858b359d46778576e2"
                    }
                }
            }
        
        - 循环 TunnelVO，初始化TunnelMonitorVO数据
        - 执行存储过程修改监控ip,monitorCidr
        - 循环 TunnelVO
            - 下发控制器（仅保存zookeeper）
            - 成功后修改TunnelVO.monitorState
        - agent不下发，让监控机自动获取
        - 数据检查
            - 检查 TunnelVO， TunnelMonitorVO数据
            - 检查agent日志
            - 检查zk数据
        - 检查数据有问题，需要再次调用消息（考虑原下发数据的清除或更新）        

    - 增加撤销初始化的消息(APIInitTunnelMonitorRollbackMsg)，配置下发错误需要撤销时调用
        {
            "com.syscxp.header.tunnel.monitor.APIInitTunnelMonitorRollbackMsg": {
            	"tunnelUuid":"1000",
                "session": {
                    "uuid": "ba12415b1b554cb6a687530cce5e259a"
                }
            }
        }

        - 删除TunnelMonitorVO数据
        - 更新TunnelVO状态
        - 删除zk配置

> ## 3. 测试验证
+ 监控开启、监控关闭
+ 修改监控ip
+ 修改通道vlan、带宽、端口
+ 专线中止、专线删除
+ 修改监控接口
+ 共点

> ## 4. 监控数据查看
    - 查看OpenTSDB数据
    - 通道数据查看 
    - 测速
    - 网络工具

# 二. falcon-api
> ## 1. 备份原falcon_portal数据
> ## 2. 表结构调整
     ALTER TABLE tunnel_icmp MODIFY tunnel_id VARCHAR(32);
     ALTER TABLE tunnel_icmp MODIFY endpointA_id VARCHAR(32);
     ALTER TABLE tunnel_icmp MODIFY endpointB_id VARCHAR(32);
     ALTER TABLE tunnel_alarm_history MODIFY tunnel_id VARCHAR(32);                                        
     ALTER TABLE tunnel_strategy MODIFY tunnel_id VARCHAR(32);
     ALTER TABLE tunnel_strategy ADD regulation_id VARCHAR(32) COMMENT '规则UUID(syscxp_alarm.RegulationVO.uuid)' AFTER stay_time;
     ALTER TABLE tunnel_strategy ADD bandwidth BIGINT(20) COMMENT '带宽' AFTER regulation_id;
     ALTER TABLE expression ADD regulation_id VARCHAR(32) NOT NULL COMMENT '规则UUID(syscxp_alarm.RegulationVO.uuid)' AFTER action_id;
     ALTER TABLE expression ADD resource_uuid VARCHAR(32) COMMENT '资源uuid' AFTER regulation_id;

> ## 2. 代码更新
    
> ## 3. 服务验证
+ 专线绑定告警策略
+ 专线解绑告警策略
+ 告警策略修改

> ## 4. 数据初始化
+ 原数据备份后，清空数据库 
+ syscxp-alarm 初始化后同步到falcon-portal
+ 初始化后数据验证

# 三. open-falcon

> ## 1. hbs
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 2. judge
+ 代码更新
+ 服务验证
    - ./control status
    - ./control tail

> ## 3. alarm
+ 停止服务
    - ./control stop
    - ./control status

# 四. syscxp-alarm
> ## 1. 项目部署
+ 修改配置

> ## 2. 数据初始化
+ 告警策略、告警规则、策略规则绑定、策略资源绑定
    - 数据整理
	    - falcon_portal.tunnel_strategy 数据导入 syscxp_alarm
	    - 新增 comparison_rule_uuid, monitor_target_uuid, policy_uuid, reguration_uuid 字段
	- 新建临时表（存储已处理数据）
            
            CREATE TABLE reguration_ts_temp (
            	tunnel_id VARCHAR (32),
            	policy_id VARCHAR (32),
            	reguration_id VARCHAR (32),
            	ts_id VARCHAR (32)
            );
    
    - 存储过程同步数据 PolicyVO, RegurationVO, ResourcePolicyRefVO
            
            CALL proc_tunnel_strategy_init;
      
    - 调用接口（APIInitAlarmStrategyMsg），同步策略规则至falcon
      {
        "com.syscxp.alarm.header.resourcePolicy.APIInitAlarmStrategyMsg": {
          "session": {
            "uuid": "5d23815f547d42b4959b2896a8e03da8"
          }
        }
      }
    - 数据验证
        - 检查 PolicyVO, RegurationVO, ResourcePolicyRefVO（syscxp_alarm）
        - 检查 tunnel_strategy， expression（falcon_portal）
        - 检查数据有问题，需要再次调用消息（考虑原下发数据的清除或更新
        
    - 目前存在触发周期为10次的数据，alarm默认最大5次
    
+ 告警联系人
    - 数据整理
        - uic.user表数据导入 syscxp_alarm
    - 调用存储过程初始化数据
    
            CALL proc_contact_init
    - 数据验证
        - 检查 ContactVO，ContactNotifyWayRefVO（syscxp_alarm）
        - 检查数据，如果数据有问题，修改后重新执行存储过程
        
                SELECT a.`cnname` old_name ,b.`name` as new_name,
                       a.`name` as old_acc,b.accountUuid as new_acc,
                       a.email as old_mail,b.email as new_mail,
                       a.phone as old_phone,b.mobile as new_phone,
                       b.uuid as contactUuid,d.`code`
                 FROM user a 
                    LEFT JOIN ContactVO b ON b.accountUuid = a.`name` AND b.`name` = a.cnname AND b.email = a.email and b.mobile = a.phone
                    LEFT JOIN ContactNotifyWayRefVO c ON c.contactUuid = b.uuid
                    LEFT JOIN NotifyWayVO d ON d.uuid = c.notifyWayUuid;
                
+ 服务验证
    - 专线绑定告警策略
    - 专线解绑告警策略
    - 告警策略修改